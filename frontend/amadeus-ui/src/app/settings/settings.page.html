<section class="settings-page">
  <header class="settings-page__header">
    <div>
      <p class="settings-page__eyebrow">Workspace</p>
      <h1 class="settings-page__title">Settings</h1>
      <p class="settings-page__subtitle">
        Manage your Amadeus account preferences and provision encrypted exchange credentials for Nautilus Trader.
      </p>
    </div>
  </header>

  <section class="account-settings">
    <header class="account-settings__header">
      <div>
        <h2 class="account-settings__title">Account</h2>
        <p class="account-settings__subtitle">
          Update your display information, login and password used to access the control plane.
        </p>
      </div>
      <span class="account-settings__timestamp" *ngIf="activeUser() as user">Last updated {{ user.updated_at | date: 'medium' }}</span>
    </header>

    <form class="account-settings__form" [formGroup]="accountForm" (ngSubmit)="saveAccountSettings()">
      <div class="account-settings__grid">
        <label class="field">
          <span class="field__label">Full name</span>
          <input class="field__control" formControlName="name" type="text" placeholder="Jane Operator" required />
        </label>

        <label class="field">
          <span class="field__label">Email</span>
          <input class="field__control" formControlName="email" type="email" placeholder="operator@example.com" required />
        </label>

        <label class="field">
          <span class="field__label">Login</span>
          <input class="field__control" formControlName="username" type="text" placeholder="operator" required />
        </label>

        <label class="field">
          <span class="field__label">Current password</span>
          <input
            class="field__control"
            formControlName="currentPassword"
            type="password"
            autocomplete="current-password"
          />
          <span class="field__hint">Required when updating your password.</span>
        </label>

        <label class="field">
          <span class="field__label">New password</span>
          <input class="field__control" formControlName="password" type="password" autocomplete="new-password" />
          <span class="field__hint">Leave blank to keep the current password.</span>
        </label>

        <label class="field">
          <span class="field__label">Confirm password</span>
          <input class="field__control" formControlName="confirmPassword" type="password" autocomplete="new-password" />
        </label>
      </div>

      <div class="account-settings__alerts">
        <p class="account-settings__error" *ngIf="accountError() as error">{{ error }}</p>
        <p class="account-settings__success" *ngIf="accountSuccess() as success">{{ success }}</p>
      </div>

      <footer class="account-settings__footer">
        <button type="submit" class="btn btn--primary" [disabled]="isAccountSaving() || accountForm.pristine">
          <span *ngIf="isAccountSaving(); else saveLabel">Saving…</span>
          <ng-template #saveLabel>Save changes</ng-template>
        </button>
      </footer>
    </form>
  </section>

  <section class="credentials-section">
    <header class="credentials-section__header">
      <div>
        <h2 class="credentials-section__title">API keys</h2>
        <p class="credentials-section__subtitle">
          Store encrypted exchange credentials and manage adapter access across Nautilus Trader nodes.
        </p>
      </div>
      <div class="credentials-section__actions">
        <button
          type="button"
          class="btn btn--ghost"
          (click)="refresh()"
          [disabled]="isLoading() || isRefreshing()"
          aria-label="Refresh API keys"
        >
          <span *ngIf="isRefreshing(); else refreshLabel">Refreshing…</span>
          <ng-template #refreshLabel>Refresh</ng-template>
        </button>
        <button type="button" class="btn btn--primary" (click)="openCreateDialog()">New key</button>
      </div>
    </header>

    <p class="credentials-section__notice" *ngIf="exchangesError() as exchangeError">{{ exchangeError }}</p>

    <section class="credentials-meta" *ngIf="lastUpdated() as updated">
      <div class="meta-card">
        <span class="meta-card__label">Last synced</span>
        <span class="meta-card__value">{{ updated | date: 'medium' }}</span>
      </div>
      <div class="meta-card" *ngIf="keys().length">
        <span class="meta-card__label">Provisioned</span>
        <span class="meta-card__value">{{ keys().length }}</span>
      </div>
    </section>

    <p class="credentials-error" *ngIf="errorText() as error">{{ error }}</p>

    <div class="credentials-loading" *ngIf="isLoading()" role="status" aria-live="polite">
      <span class="credentials-spinner" aria-hidden="true"></span>
      <span>Loading API keys…</span>
    </div>

    <ng-container *ngIf="!isLoading()">
      <section class="credentials-table" *ngIf="keys().length > 0; else emptyState">
        <table>
          <thead>
            <tr>
              <th>Label</th>
              <th>Venue</th>
              <th>Access key</th>
              <th>Scopes</th>
              <th>Status</th>
              <th>Created</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let key of keys(); trackBy: trackByKeyId">
              <td data-label="Label">
                <div class="cell-main">{{ key.label || key.key_id }}</div>
                <div class="cell-sub"><code>{{ key.key_id }}</code></div>
              </td>
              <td data-label="Venue">
                <div class="cell-main">{{ key.venue }}</div>
              </td>
              <td data-label="Access key">
                <div class="cell-main">{{ maskSecret(key) }}</div>
                <div class="cell-sub" *ngIf="key.fingerprint">Fingerprint {{ key.fingerprint }}</div>
              </td>
              <td data-label="Scopes">
                <ul class="scope-list">
                  <li *ngFor="let scope of key.scopes">{{ scope }}</li>
                </ul>
              </td>
              <td data-label="Status">
                <ng-container *ngIf="keyStatus(key) as status">
                  <span
                    class="status"
                    [class.status--active]="status.tone === 'active'"
                    [class.status--stale]="status.tone === 'stale'"
                    [class.status--idle]="status.tone === 'idle'"
                    [class.status--expiring]="status.tone === 'expiring'"
                    [class.status--expired]="status.tone === 'expired'"
                  >
                    {{ status.label }}
                  </span>
                  <div class="cell-sub">{{ status.description }}</div>
                </ng-container>
              </td>
              <td data-label="Created">
                <div class="cell-main">{{ key.created_at | date: 'medium' }}</div>
                <div class="cell-sub" *ngIf="key.last_used_at">Last used {{ key.last_used_at | date: 'medium' }}</div>
              </td>
              <td data-label="Actions" class="credentials-table__actions">
                <button type="button" class="btn btn--ghost" (click)="openEditDialog(key)">Edit</button>
                <button type="button" class="btn btn--ghost" (click)="openDeleteDialog(key)">Delete</button>
              </td>
            </tr>
          </tbody>
        </table>
      </section>
    </ng-container>

    <ng-template #emptyState>
      <div class="credentials-empty">
        <h3>Securely manage your credentials</h3>
        <p>
          Provision encrypted API keys for each venue to unlock trading, data collection and withdrawal workflows across your
          Nautilus Trader infrastructure.
        </p>
        <button type="button" class="btn btn--primary" (click)="openCreateDialog()">Create your first key</button>
      </div>
    </ng-template>
  </section>

  <section class="assignments-section" aria-label="Credential assignments">
    <header class="assignments-section__header">
      <div>
        <h2 class="assignments-section__title">Adapter credential assignments</h2>
        <p class="assignments-section__subtitle">
          Link provisioned API keys to node adapters and execution strategies to ensure venue access.
        </p>
      </div>
      <button
        type="button"
        class="btn btn--ghost"
        (click)="reloadAssignments()"
        [disabled]="isAssignmentsLoading()"
      >
        <span *ngIf="isAssignmentsLoading(); else syncLabel">Syncing…</span>
        <ng-template #syncLabel>Sync context</ng-template>
      </button>
    </header>

    <p class="assignments-section__error" *ngIf="assignmentsError() as assignError">{{ assignError }}</p>

    <div class="assignments-section__loading" *ngIf="isAssignmentsLoading()" role="status" aria-live="polite">
      Loading node context…
    </div>

    <ng-container *ngIf="assignmentsView().length > 0; else noAssignments">
      <article
        class="assignment-card"
        *ngFor="let assignment of assignmentsView()"
        [class.assignment-card--warning]="assignment.hasWarnings"
      >
        <header class="assignment-card__header">
          <div>
            <h3 class="assignment-card__title">Node {{ assignment.nodeId }}</h3>
            <p class="assignment-card__subtitle">
              {{ assignment.strategyName }} • {{ formatMode(assignment.nodeMode) }}
            </p>
          </div>
          <span class="assignment-card__badge" *ngIf="assignment.hasWarnings">Attention</span>
        </header>

        <div class="assignment-card__body" *ngIf="assignment.adapters.length; else noAdapters">
          <section class="adapter-card" *ngFor="let adapter of assignment.adapters">
            <header class="adapter-card__header">
              <div>
                <h4 class="adapter-card__title">{{ adapter.label }}</h4>
                <p class="adapter-card__meta">
                  Venue: {{ formatVenue(adapter.venue) }} •
                  Environment: {{ formatEnvironment(adapter.environment) }} •
                  Mode: {{ formatMode(adapter.mode) }}
                </p>
              </div>
            </header>

            <div class="adapter-card__controls">
              <label class="field">
                <span class="field__label">Assigned key</span>
                <select
                  class="field__control field__control--select"
                  [value]="adapter.assignedKeyId || ''"
                  (change)="onAssignmentChange(adapter.selectionKey, $any($event.target).value)"
                >
                  <option value="">Not assigned</option>
                  <option *ngFor="let option of adapter.options" [value]="option.key.key_id">
                    {{ adapterOptionLabel(option) }}
                  </option>
                </select>
              </label>
            </div>

            <ul class="adapter-card__warnings" *ngIf="adapter.warnings.length">
              <li *ngFor="let warning of adapter.warnings">{{ warning }}</li>
            </ul>
          </section>
        </div>

        <ng-template #noAdapters>
          <p class="assignment-card__empty">No adapters reported for this node.</p>
        </ng-template>
      </article>
    </ng-container>

    <ng-template #noAssignments>
      <p class="assignments-section__empty">
        No active nodes require credential assignments. Launch a node to begin mapping API keys.
      </p>
    </ng-template>
  </section>

  <ng-container *ngIf="isCreateDialogOpen()">
    <div class="dialog" role="presentation">
      <div class="dialog__backdrop" (click)="closeCreateDialog()" aria-hidden="true"></div>
      <div class="dialog__panel" role="dialog" aria-modal="true" aria-labelledby="createKeyTitle">
        <header class="dialog__header">
          <div>
            <p class="dialog__eyebrow">Create credential</p>
            <h2 class="dialog__title" id="createKeyTitle">New API key</h2>
            <p class="dialog__subtitle">
              Encrypt your secret with a passphrase before sending it to the credential vault.
            </p>
          </div>
          <button type="button" class="dialog__close" (click)="closeCreateDialog()" aria-label="Close create dialog">
            ×
          </button>
        </header>

        <form class="dialog__form" [formGroup]="createForm" (ngSubmit)="createKey()">
          <div class="dialog__body">
            <label class="field">
              <span class="field__label">Key label</span>
              <input class="field__control" formControlName="label" type="text" placeholder="Primary trading key" />
            </label>

            <label class="field">
              <span class="field__label">Key identifier</span>
              <input
                class="field__control"
                formControlName="keyId"
                type="text"
                placeholder="binance-primary"
                required
              />
              <span class="field__hint" *ngIf="createForm.controls.keyId.invalid && createForm.controls.keyId.touched">
                Identifier is required.
              </span>
            </label>

            <label class="field field--full">
              <span class="field__label">Venue</span>
              <select
                class="field__control field__control--select"
                [value]="isCreateCustomVenue() ? '__custom__' : createForm.controls.venue.value"
                (change)="onCreateVenueSelected($any($event.target).value)"
                required
              >
                <option value="" disabled>Select a venue</option>
                <option *ngFor="let exchange of venueOptions()" [value]="exchange.code">
                  {{ exchange.name }} ({{ exchange.code }})
                </option>
                <option value="__custom__">Custom venue…</option>
              </select>
              <span class="field__hint" *ngIf="isExchangesLoading()">Loading exchanges…</span>
            </label>

            <label class="field field--full" *ngIf="isCreateCustomVenue()">
              <span class="field__label">Custom venue</span>
              <input
                class="field__control"
                type="text"
                formControlName="venue"
                placeholder="BINANCE"
                required
              />
            </label>

            <label class="field field--full">
              <span class="field__label">API key</span>
              <input class="field__control" formControlName="apiKey" type="text" autocomplete="off" required />
              <span class="field__hint" *ngIf="createForm.controls.apiKey.invalid && createForm.controls.apiKey.touched">
                API key is required.
              </span>
            </label>

            <label class="field field--full">
              <span class="field__label">API secret</span>
              <textarea
                class="field__control"
                formControlName="apiSecret"
                rows="2"
                autocomplete="off"
                required
              ></textarea>
              <span class="field__hint" *ngIf="createForm.controls.apiSecret.invalid && createForm.controls.apiSecret.touched">
                API secret is required.
              </span>
            </label>

            <fieldset class="field field--fieldset field--full">
              <legend class="field__label">Scopes</legend>
              <div class="scope-options">
                <label class="checkbox">
                  <input type="checkbox" formControlName="scopeRead" />
                  <span>Read</span>
                </label>
                <label class="checkbox">
                  <input type="checkbox" formControlName="scopeTrade" />
                  <span>Trade</span>
                </label>
                <label class="checkbox">
                  <input type="checkbox" formControlName="scopeWithdraw" />
                  <span>Withdraw</span>
                </label>
              </div>
              <label class="field field--inline">
                <span class="field__label">Additional scopes</span>
                <input
                  class="field__control"
                  type="text"
                  formControlName="scopeCustom"
                  placeholder="Separate custom scopes with commas"
                />
              </label>
            </fieldset>

            <label class="field">
              <span class="field__label">Passphrase</span>
              <input
                class="field__control"
                formControlName="passphrase"
                type="password"
                autocomplete="new-password"
                required
                minlength="8"
              />
              <span class="field__hint" *ngIf="createForm.controls.passphrase.invalid && createForm.controls.passphrase.touched">
                Passphrase must be at least 8 characters.
              </span>
            </label>

            <label class="field">
              <span class="field__label">Passphrase hint (optional)</span>
              <input class="field__control" formControlName="passphraseHint" type="text" placeholder="Production wallet" />
            </label>
          </div>

          <p class="dialog__error" *ngIf="createError() as error">{{ error }}</p>

          <footer class="dialog__footer">
            <button type="button" class="btn btn--ghost" (click)="closeCreateDialog()">Cancel</button>
            <button type="submit" class="btn btn--primary" [disabled]="isCreateSubmitting()">
              <span *ngIf="isCreateSubmitting(); else createLabel">Encrypt &amp; save</span>
              <ng-template #createLabel>Encrypt &amp; save</ng-template>
            </button>
          </footer>
        </form>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="isEditDialogOpen() && editDialogKey() as key">
    <div class="dialog" role="presentation">
      <div class="dialog__backdrop" (click)="closeEditDialog()" aria-hidden="true"></div>
      <div class="dialog__panel" role="dialog" aria-modal="true" aria-labelledby="editKeyTitle">
        <header class="dialog__header">
          <div>
            <p class="dialog__eyebrow">Update credential</p>
            <h2 class="dialog__title" id="editKeyTitle">{{ key.label || key.key_id }}</h2>
            <p class="dialog__subtitle">
              Adjust metadata or rotate secrets by submitting a newly encrypted payload with your passphrase.
            </p>
          </div>
          <button type="button" class="dialog__close" (click)="closeEditDialog()" aria-label="Close edit dialog">×</button>
        </header>

        <form class="dialog__form" [formGroup]="editForm" (ngSubmit)="updateKey()">
          <div class="dialog__body">
            <label class="field">
              <span class="field__label">Key identifier</span>
              <input class="field__control" formControlName="keyId" type="text" readonly />
            </label>

            <label class="field">
              <span class="field__label">Label</span>
              <input class="field__control" formControlName="label" type="text" />
            </label>

            <label class="field field--full">
              <span class="field__label">Venue</span>
              <select
                class="field__control field__control--select"
                [value]="isEditCustomVenue() ? '__custom__' : editForm.controls.venue.value"
                (change)="onEditVenueSelected($any($event.target).value)"
                required
              >
                <option value="" disabled>Select a venue</option>
                <option *ngFor="let exchange of venueOptions()" [value]="exchange.code">
                  {{ exchange.name }} ({{ exchange.code }})
                </option>
                <option value="__custom__">Custom venue…</option>
              </select>
            </label>

            <label class="field field--full" *ngIf="isEditCustomVenue()">
              <span class="field__label">Custom venue</span>
              <input class="field__control" formControlName="venue" type="text" required />
            </label>

            <fieldset class="field field--fieldset field--full">
              <legend class="field__label">Scopes</legend>
              <div class="scope-options">
                <label class="checkbox">
                  <input type="checkbox" formControlName="scopeRead" />
                  <span>Read</span>
                </label>
                <label class="checkbox">
                  <input type="checkbox" formControlName="scopeTrade" />
                  <span>Trade</span>
                </label>
                <label class="checkbox">
                  <input type="checkbox" formControlName="scopeWithdraw" />
                  <span>Withdraw</span>
                </label>
              </div>
              <label class="field field--inline">
                <span class="field__label">Additional scopes</span>
                <input
                  class="field__control"
                  type="text"
                  formControlName="scopeCustom"
                  placeholder="Separate custom scopes with commas"
                />
              </label>
            </fieldset>

            <label class="checkbox checkbox--inline">
              <input type="checkbox" formControlName="rotateSecret" />
              <span>Rotate API key &amp; secret</span>
            </label>

            <ng-container *ngIf="editForm.controls.rotateSecret.value">
              <label class="field field--full">
                <span class="field__label">New API key</span>
                <input class="field__control" formControlName="apiKey" type="text" autocomplete="off" />
              </label>

              <label class="field field--full">
                <span class="field__label">New API secret</span>
                <textarea class="field__control" formControlName="apiSecret" rows="2" autocomplete="off"></textarea>
              </label>
            </ng-container>

            <label class="field">
              <span class="field__label">Passphrase</span>
              <input
                class="field__control"
                formControlName="passphrase"
                type="password"
                autocomplete="current-password"
                required
                minlength="8"
              />
            </label>

            <label class="field">
              <span class="field__label">Passphrase hint (optional)</span>
              <input class="field__control" formControlName="passphraseHint" type="text" />
            </label>
          </div>

          <p class="dialog__error" *ngIf="editError() as error">{{ error }}</p>

          <footer class="dialog__footer">
            <button type="button" class="btn btn--ghost" (click)="closeEditDialog()">Cancel</button>
            <button type="submit" class="btn btn--primary" [disabled]="isEditSubmitting()">
              <span *ngIf="isEditSubmitting(); else updateLabel">Encrypt &amp; update</span>
              <ng-template #updateLabel>Encrypt &amp; update</ng-template>
            </button>
          </footer>
        </form>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="isDeleteDialogOpen() && deleteDialogKey() as key">
    <div class="dialog" role="presentation">
      <div class="dialog__backdrop" (click)="closeDeleteDialog()" aria-hidden="true"></div>
      <div class="dialog__panel" role="dialog" aria-modal="true" aria-labelledby="deleteKeyTitle">
        <header class="dialog__header dialog__header--danger">
          <div>
            <p class="dialog__eyebrow">Delete credential</p>
            <h2 class="dialog__title" id="deleteKeyTitle">Remove {{ key.label || key.key_id }}?</h2>
            <p class="dialog__subtitle">
              Deleting a key immediately revokes adapter access. Confirm the identifier and provide your passphrase to continue.
            </p>
          </div>
          <button type="button" class="dialog__close" (click)="closeDeleteDialog()" aria-label="Close delete dialog">
            ×
          </button>
        </header>

        <form class="dialog__form" [formGroup]="deleteForm" (ngSubmit)="deleteKeyConfirmed()">
          <div class="dialog__body">
            <label class="field">
              <span class="field__label">Type <code>{{ key.key_id }}</code> to confirm</span>
              <input class="field__control" formControlName="confirmation" type="text" autocomplete="off" required />
            </label>

            <label class="field">
              <span class="field__label">Passphrase</span>
              <input
                class="field__control"
                formControlName="passphrase"
                type="password"
                autocomplete="current-password"
                required
                minlength="8"
              />
            </label>
          </div>

          <p class="dialog__error" *ngIf="deleteError() as error">{{ error }}</p>

          <footer class="dialog__footer">
            <button type="button" class="btn btn--ghost" (click)="closeDeleteDialog()">Cancel</button>
            <button type="submit" class="btn btn--primary btn--danger" [disabled]="isDeleteSubmitting()">
              <span *ngIf="isDeleteSubmitting(); else deleteLabel">Delete permanently</span>
              <ng-template #deleteLabel>Delete permanently</ng-template>
            </button>
          </footer>
        </form>
      </div>
    </div>
  </ng-container>
</section>
