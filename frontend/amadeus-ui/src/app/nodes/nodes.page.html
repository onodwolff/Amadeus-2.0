<section class="nodes-page">
  <header class="nodes-page__header">
    <div>
      <h1 class="nodes-page__title">Dashboard</h1>
      <p class="nodes-page__subtitle">
        Monitor trading bots across backtest, simulation, and live venues. Launch new bots and control existing ones in real
        time.
      </p>
    </div>
    <div class="nodes-page__actions">
      <div class="nodes-page__launch">
        <label class="nodes-page__launch-label" for="launchModeSelect">Launch mode</label>
        <div class="nodes-page__launch-control">
          <select
            id="launchModeSelect"
            class="nodes-page__launch-select"
            [value]="launchMode()"
            (change)="onLaunchModeChange($event)"
            [disabled]="isLaunching()"
          >
            <option value="backtest">Backtest</option>
            <option value="sandbox">Sandbox</option>
            <option value="live">Live</option>
          </select>
        </div>
      </div>
      <button
        type="button"
        class="btn btn--primary"
        (click)="openWizard(launchDialog, launchMode())"
        [disabled]="isLaunching()"
      >
        Launch bot
      </button>
      <button type="button" class="btn" (click)="refresh()" [disabled]="isLoading()">Refresh bots</button>
    </div>
  </header>

  <app-node-launch-dialog #launchDialog (launch)="onLaunchNode($event, launchDialog)"></app-node-launch-dialog>

  <div class="nodes-page__meta">
    <div class="meta-card">
      <span class="meta-card__label">Active bots</span>
      <span class="meta-card__value">
        {{ runningBots() }} / {{ totalBots() }}
      </span>
      <span class="meta-card__hint">Running / total</span>
      <span class="meta-card__hint">Paused: {{ pausedBots() }}</span>
    </div>
    <div class="meta-card">
      <span class="meta-card__label">Total PnL</span>
      <span
        class="meta-card__value"
        [class.meta-card__value--warn]="totalPnl() < 0"
        [class.meta-card__value--good]="totalPnl() > 0"
      >
        ${{ totalPnl() | number: '1.2-2' }}
      </span>
    </div>
    <div class="meta-card">
      <span class="meta-card__label">Total equity</span>
      <span class="meta-card__value">${{ totalEquity() | number: '1.0-0' }}</span>
    </div>
    <div class="meta-card" *ngIf="averageLatencyMs() as latency">
      <span class="meta-card__label">Avg latency</span>
      <span class="meta-card__value">{{ latency | number: '1.0-0' }} ms</span>
    </div>
    <div class="meta-card">
      <span class="meta-card__label">WebSocket</span>
      <span class="meta-card__value" [class.meta-card__value--warn]="wsState() !== 'connected'">{{ wsState() }}</span>
    </div>
    <div class="meta-card" *ngIf="healthInfo() as health">
      <span class="meta-card__label">Gateway health</span>
      <span class="meta-card__value" [class.meta-card__value--warn]="health.status !== 'ok'">
        {{ (health.status || 'unknown') | titlecase }}
        <ng-container *ngIf="health.adapters">
          • {{ health.adapters.connected }}/{{ health.adapters.total }} adapters
        </ng-container>
      </span>
    </div>
    <div class="meta-card" *ngIf="coreInfo() as core">
      <span class="meta-card__label">Nautilus core</span>
      <span class="meta-card__value" [class.meta-card__value--warn]="!core.available">
        {{ core.available ? 'Online' : 'Offline' }}
        <ng-container *ngIf="core.adapters">
          • {{ core.adapters.connected }}/{{ core.adapters.total }} adapters
        </ng-container>
      </span>
      <span class="meta-card__hint" *ngIf="core.nautilus_version">v{{ core.nautilus_version }}</span>
    </div>
  </div>

  <p class="nodes-page__error" *ngIf="errorText() as error">{{ error }}</p>

  <ng-container *ngIf="isLoading(); else nodesContent">
    <div class="nodes-page__loading" role="status" aria-live="polite">
      <span class="nodes-page__spinner" aria-hidden="true"></span>
      <span>Loading bots…</span>
    </div>
  </ng-container>

  <ng-template #nodesContent>
    <ng-container *ngIf="hasNodes(); else emptyState">
      <div class="nodes-layout" [class.nodes-layout--detail-open]="selectedNode()">
        <div class="nodes-table">
          <table>
            <thead>
              <tr>
                <th>Bot ID</th>
                <th>Mode</th>
                <th>Strategy</th>
                <th>Status</th>
                <th>Description</th>
                <th>PnL</th>
                <th>Equity</th>
                <th>Latency</th>
                <th>Controls</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let node of nodes()"
                (click)="openNodeDetail(node)"
                [class.is-selected]="selectedNodeId() === node.id"
              >
                <td data-label="Bot ID"><code>{{ node.id }}</code></td>
                <td data-label="Mode"><span class="tag">{{ node.mode | titlecase }}</span></td>
                <td data-label="Strategy" class="strategy">
                  <ng-container *ngIf="node.summary?.strategy as strategy; else noStrategy">
                    <span class="strategy__name">{{ strategy.name || strategy.id || '—' }}</span>
                    <span class="strategy__meta" *ngIf="strategy.id && strategy.name && strategy.id !== strategy.name">
                      ({{ strategy.id }})
                    </span>
                  </ng-container>
                  <ng-template #noStrategy>—</ng-template>
                </td>
                <td data-label="Status">
                  <span
                    class="status"
                    [class.status--running]="node.status === 'running'"
                    [class.status--stopped]="node.status !== 'running'"
                    >{{ node.status | titlecase }}</span
                  >
                </td>
                <td data-label="Description" class="detail">{{ node.detail || '—' }}</td>
                <td data-label="PnL">
                  <ng-container *ngIf="metric(node, 'pnl') as pnl; else noPnl">
                    ${{ pnl | number: '1.2-2' }}
                  </ng-container>
                </td>
                <ng-template #noPnl>—</ng-template>
                <td data-label="Equity" class="equity">
                  <ng-container *ngIf="metric(node, 'equity') as equityValue; else noEquity">
                    <div class="equity-cell">
                      <span class="equity-cell__value">${{ equityValue | number: '1.0-0' }}</span>
                      <app-equity-sparkline
                        class="equity-cell__sparkline"
                        [series]="node.metrics?.equity_history ?? node.summary?.metrics?.equity_history ?? []"
                        [width]="96"
                        [height]="28"
                      ></app-equity-sparkline>
                    </div>
                  </ng-container>
                </td>
                <ng-template #noEquity>—</ng-template>
                <td data-label="Latency">
                  <ng-container *ngIf="metric(node, 'latency_ms') as latency; else noLatency">
                    {{ latency | number: '1.0-0' }} ms
                  </ng-container>
                </td>
                <ng-template #noLatency>—</ng-template>
                <td data-label="Controls" class="actions">
                  <button
                    type="button"
                    class="btn btn--ghost"
                    *ngIf="node.status !== 'running'"
                    (click)="onStartClick($event, node)"
                    [disabled]="restartingNodeId() === node.id"
                  >
                    {{ restartingNodeId() === node.id ? 'Starting…' : 'Start' }}
                  </button>
                  <button
                    type="button"
                    class="btn btn--ghost"
                    *ngIf="node.status === 'running'"
                    (click)="onStopClick($event, node)"
                    [disabled]="stoppingNodeId() === node.id"
                  >
                    {{ stoppingNodeId() === node.id ? 'Stopping…' : 'Stop' }}
                  </button>
                  <button
                    type="button"
                    class="btn btn--ghost"
                    (click)="onRestartClick($event, node)"
                    [disabled]="restartingNodeId() === node.id"
                  >
                    {{ restartingNodeId() === node.id ? 'Restarting…' : 'Restart' }}
                  </button>
                  <button
                    type="button"
                    class="btn btn--ghost btn--danger"
                    (click)="onDeleteClick($event, node)"
                    [disabled]="deletingNodeId() === node.id"
                  >
                    {{ deletingNodeId() === node.id ? 'Deleting…' : 'Delete' }}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <app-node-detail
          *ngIf="selectedNode() as selected"
          [node]="selected"
          [detail]="nodeDetail()"
          [lifecycle]="nodeLifecycle()"
          [logs]="nodeLogs()"
          [isLoadingDetail]="isDetailLoading()"
          [isLoadingLogs]="isLogsLoading()"
          [detailError]="detailError()"
          [logsError]="logsError()"
          [logStreamState]="logStreamState()"
          [isRestarting]="restartingNodeId() === selected.id"
          [isStopping]="stoppingNodeId() === selected.id"
          [isDeleting]="deletingNodeId() === selected.id"
          [isDownloadingLogs]="isDownloadingLogs()"
          (closed)="closeDetail()"
          (restartRequested)="restart(selected)"
          (stopRequested)="stop(selected)"
          (deleteRequested)="delete(selected)"
          (logsDownloadRequested)="downloadLogs(selected)"
        ></app-node-detail>
      </div>
    </ng-container>
  </ng-template>

  <ng-template #emptyState>
    <div class="empty-state">
      <h2>No bots yet</h2>
      <p>Launch a backtest, sandbox, or live bot to see it appear here.</p>
    </div>
  </ng-template>
</section>
