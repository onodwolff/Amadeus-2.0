<section class="nodes-page">
  <header class="nodes-page__header">
    <div>
      <h1 class="nodes-page__title">Nodes</h1>
      <p class="nodes-page__subtitle">
        Manage Nautilus Trader sessions. Launch new backtests, sandbox nodes, or live trading sessions and monitor their status in
        real time.
      </p>
    </div>
    <div class="nodes-page__actions">
      <button
        type="button"
        class="btn btn--primary"
        (click)="openWizard(launchDialog, 'backtest')"
        [disabled]="isLaunching()"
      >
        Launch backtest
      </button>
      <button
        type="button"
        class="btn btn--primary"
        (click)="openWizard(launchDialog, 'sandbox')"
        [disabled]="isLaunching()"
      >
        Launch sandbox
      </button>
      <button
        type="button"
        class="btn btn--primary"
        (click)="openWizard(launchDialog, 'live')"
        [disabled]="isLaunching()"
      >
        Launch live
      </button>
      <button type="button" class="btn" (click)="refresh()" [disabled]="isLoading()">Refresh</button>
    </div>
  </header>

  <app-node-launch-dialog #launchDialog (launch)="onLaunchNode($event, launchDialog)"></app-node-launch-dialog>

  <div class="nodes-page__meta">
    <div class="meta-card">
      <span class="meta-card__label">WebSocket</span>
      <span class="meta-card__value" [class.meta-card__value--warn]="wsState() !== 'connected'">{{ wsState() }}</span>
    </div>
    <div class="meta-card" *ngIf="healthInfo() as health">
      <span class="meta-card__label">Gateway health</span>
      <span class="meta-card__value" [class.meta-card__value--warn]="health.status !== 'ok'">
        {{ (health.status || 'unknown') | titlecase }}
        <ng-container *ngIf="health.adapters">
          • {{ health.adapters.connected }}/{{ health.adapters.total }} adapters
        </ng-container>
      </span>
    </div>
    <div class="meta-card" *ngIf="coreInfo() as core">
      <span class="meta-card__label">Nautilus core</span>
      <span class="meta-card__value" [class.meta-card__value--warn]="!core.available">
        {{ core.available ? 'Online' : 'Offline' }}
        <ng-container *ngIf="core.adapters">
          • {{ core.adapters.connected }}/{{ core.adapters.total }} adapters
        </ng-container>
      </span>
      <span class="meta-card__hint" *ngIf="core.nautilus_version">v{{ core.nautilus_version }}</span>
    </div>
  </div>

  <p class="nodes-page__error" *ngIf="errorText() as error">{{ error }}</p>

  <ng-container *ngIf="isLoading(); else nodesContent">
    <div class="nodes-page__loading" role="status" aria-live="polite">
      <span class="nodes-page__spinner" aria-hidden="true"></span>
      <span>Loading nodes…</span>
    </div>
  </ng-container>

  <ng-template #nodesContent>
    <ng-container *ngIf="hasNodes(); else emptyState">
      <div class="nodes-layout" [class.nodes-layout--detail-open]="selectedNode()">
        <div class="nodes-table">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Mode</th>
                <th>Strategy</th>
                <th>Status</th>
                <th>Detail</th>
                <th>PnL</th>
                <th>Equity</th>
                <th>Latency</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let node of nodes()"
                (click)="openNodeDetail(node)"
                [class.is-selected]="selectedNodeId() === node.id"
              >
                <td data-label="ID"><code>{{ node.id }}</code></td>
                <td data-label="Mode"><span class="tag">{{ node.mode | titlecase }}</span></td>
                <td data-label="Strategy" class="strategy">
                  <ng-container *ngIf="node.summary?.strategy as strategy; else noStrategy">
                    <span class="strategy__name">{{ strategy.name || strategy.id || '—' }}</span>
                    <span class="strategy__meta" *ngIf="strategy.id && strategy.name && strategy.id !== strategy.name">
                      ({{ strategy.id }})
                    </span>
                  </ng-container>
                  <ng-template #noStrategy>—</ng-template>
                </td>
                <td data-label="Status">
                  <span
                    class="status"
                    [class.status--running]="node.status === 'running'"
                    [class.status--stopped]="node.status !== 'running'"
                    >{{ node.status | titlecase }}</span
                  >
                </td>
                <td data-label="Detail" class="detail">{{ node.detail || '—' }}</td>
                <td data-label="PnL">{{ node.metrics?.pnl ?? node.summary?.pnl ?? '—' }}</td>
                <td data-label="Equity" class="equity">
                  <ng-container
                    *ngIf="(node.metrics?.equity ?? node.summary?.equity) as equityValue; else noEquity"
                  >
                    <div class="equity-cell">
                      <span class="equity-cell__value">${{ equityValue | number: '1.0-0' }}</span>
                      <app-equity-sparkline
                        class="equity-cell__sparkline"
                        [series]="node.metrics?.equity_history ?? node.summary?.metrics?.equity_history ?? []"
                        [width]="96"
                        [height]="28"
                      ></app-equity-sparkline>
                    </div>
                  </ng-container>
                  <ng-template #noEquity>—</ng-template>
                </td>
                <td data-label="Latency">
                  <ng-container
                    *ngIf="
                      (node.metrics?.latency_ms ?? node.summary?.latency_ms) !== undefined &&
                      (node.metrics?.latency_ms ?? node.summary?.latency_ms) !== null;
                      else noLatency
                    "
                  >
                    {{ (node.metrics?.latency_ms ?? node.summary?.latency_ms) | number: '1.0-0' }} ms
                  </ng-container>
                  <ng-template #noLatency>—</ng-template>
                </td>
                <td data-label="Actions" class="actions">
                  <button
                    type="button"
                    class="btn btn--ghost"
                    (click)="onStopClick($event, node)"
                    [disabled]="node.status !== 'running' || isStopping()"
                  >
                    Stop
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <app-node-detail
          *ngIf="selectedNode() as selected"
          [node]="selected"
          [detail]="nodeDetail()"
          [lifecycle]="nodeLifecycle()"
          [logs]="nodeLogs()"
          [isLoadingDetail]="isDetailLoading()"
          [isLoadingLogs]="isLogsLoading()"
          [detailError]="detailError()"
          [logsError]="logsError()"
          [logStreamState]="logStreamState()"
          [isRestarting]="isRestarting()"
          [isStopping]="isStopping()"
          [isDownloadingLogs]="isDownloadingLogs()"
          (closed)="closeDetail()"
          (restartRequested)="restart(selected)"
          (stopRequested)="stop(selected)"
          (logsDownloadRequested)="downloadLogs(selected)"
        ></app-node-detail>
      </div>
    </ng-container>
  </ng-template>

  <ng-template #emptyState>
    <div class="empty-state">
      <h2>No nodes yet</h2>
      <p>Launch a backtest, sandbox, or live session to see it appear here.</p>
    </div>
  </ng-template>
</section>
