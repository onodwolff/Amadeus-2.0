<div class="launch-dialog" *ngIf="isOpen()">
  <div class="launch-dialog__backdrop" (click)="close()" aria-hidden="true"></div>
  <div class="launch-dialog__panel" role="dialog" aria-modal="true" aria-labelledby="launchDialogTitle">
    <header class="launch-dialog__header">
      <div>
        <p class="launch-dialog__eyebrow">Bot launch wizard</p>
        <h2 class="launch-dialog__title" id="launchDialogTitle">{{ currentStepDescriptor().title }}</h2>
        <p class="launch-dialog__subtitle">{{ currentStepDescriptor().description }}</p>
      </div>
      <button type="button" class="launch-dialog__close" (click)="close()" aria-label="Close launch wizard">×</button>
    </header>

    <nav class="launch-dialog__steps" aria-label="Wizard steps">
      <ol>
        <li *ngFor="let step of steps; let i = index" [class.launch-dialog__step--active]="i === currentStep()">
          <span class="launch-dialog__step-index">{{ i + 1 }}</span>
          <span class="launch-dialog__step-label">{{ step.title }}</span>
        </li>
      </ol>
    </nav>

    <form
      class="launch-dialog__form"
      id="nodeLaunchForm"
      [formGroup]="form"
      (ngSubmit)="submit()"
    >
      <section *ngIf="currentStep() === 0" class="launch-dialog__section" aria-label="Bot mode selection">
        <p class="launch-dialog__notice" *ngIf="needsLiveApiKeyWarning()">
          Live trading requires at least one exchange API key. Add credentials in Settings before continuing.
        </p>
        <div class="option-grid">
          <label *ngFor="let option of nodeTypeOptions" class="option-card" [class.option-card--active]="form.value.nodeType === option.value">
            <input type="radio" formControlName="nodeType" [value]="option.value" />
            <span class="option-card__title">{{ option.label }}</span>
            <span class="option-card__description">{{ option.description }}</span>
          </label>
        </div>
      </section>

      <section *ngIf="currentStep() === 1" class="launch-dialog__section" formGroupName="strategy" aria-label="Strategy configuration">
        <label class="field">
          <span class="field__label">Strategy template</span>
          <select class="field__control" formControlName="id" (change)="onTemplateChange($event)">
            <option *ngFor="let option of strategyTemplates" [value]="option.id">{{ option.name }}</option>
          </select>
          <span class="field__hint">
            {{ selectedStrategyDescription() }}
          </span>
        </label>

        <label class="field">
          <span class="field__label">Strategy instance name</span>
          <input class="field__control" type="text" formControlName="name" placeholder="EMA Cross demo" />
        </label>

        <div class="field">
          <div class="field__label">Runtime parameters</div>
          <div class="parameter-list" formArrayName="parameters">
            <div class="parameter-list__item" *ngFor="let param of strategyParameters().controls; let i = index" [formGroupName]="i">
              <input class="field__control" type="text" formControlName="key" placeholder="Parameter key" />
              <input class="field__control" type="text" formControlName="value" placeholder="Value" />
              <button type="button" class="btn-icon" (click)="removeStrategyParameter(i)" aria-label="Remove parameter">✕</button>
            </div>
          </div>
          <button type="button" class="btn-secondary" (click)="addStrategyParameter()">Add parameter</button>
        </div>
      </section>

      <section *ngIf="currentStep() === 2" class="launch-dialog__section" aria-label="Exchange selection">
        <div class="field">
          <span class="field__label">Venues & credentials</span>
          <span class="field__hint"
            >Enable exchanges that have provisioned API keys to register market data and execution adapters.</span
          >
        </div>
        <p class="launch-dialog__error" *ngIf="keysError() as keyError">{{ keyError }}</p>
        <p class="launch-dialog__error" *ngIf="exchangesError() as exchangeError">{{ exchangeError }}</p>
        <div class="adapter-grid">
          <div
            class="adapter-card"
            *ngFor="let option of venueOptions()"
            [class.adapter-card--disabled]="option.keys.length === 0"
          >
            <label class="adapter-card__toggle">
              <input
                type="checkbox"
                [checked]="isVenueSelected(option.code)"
                [disabled]="option.keys.length === 0"
                (change)="onVenueToggle(option, $any($event.target).checked)"
              />
              <span class="adapter-card__title">{{ option.name }}</span>
            </label>
            <p class="adapter-card__hint" *ngIf="option.keys.length === 0">
              Add API keys for {{ option.name }} in Settings to enable this venue.
            </p>
            <ng-container *ngIf="adapterGroup(option.code) as group">
              <div class="adapter-card__body">
                <label class="field">
                  <span class="field__label">API key</span>
                  <select
                    class="field__control"
                    [value]="group.controls.keyId.value"
                    (change)="onAdapterKeyChanged(option.code, $any($event.target).value)"
                  >
                    <option value="" disabled>Select key</option>
                    <option *ngFor="let key of option.keys" [value]="key.key_id">
                      {{ key.label || key.key_id }}
                    </option>
                  </select>
                </label>
                <div class="adapter-card__toggles">
                  <label class="checkbox">
                    <input type="checkbox" [formControl]="group.controls.enableData" />
                    <span>Market data</span>
                  </label>
                  <label class="checkbox">
                    <input
                      type="checkbox"
                      [formControl]="group.controls.enableTrading"
                      [disabled]="form.controls.nodeType.value !== 'live'"
                    />
                    <span>Trading</span>
                  </label>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
        <div class="launch-dialog__empty-hint" *ngIf="!venueOptions().length && !isKeysLoading() && !isExchangesLoading()">
          <p>No exchanges available yet. Add API keys in Settings to enable adapters for live trading.</p>
        </div>
      </section>

      <section *ngIf="currentStep() === 3" class="launch-dialog__section" formGroupName="constraints" aria-label="Launch constraints">
        <div class="constraints-grid">
          <label class="field">
            <span class="field__label">Max runtime (minutes)</span>
            <input class="field__control" type="number" formControlName="maxRuntimeMinutes" min="1" placeholder="480" />
          </label>
          <label class="field">
            <span class="field__label">Max drawdown (%)</span>
            <input class="field__control" type="number" formControlName="maxDrawdownPercent" min="1" max="100" placeholder="20" />
          </label>
          <label class="field">
            <span class="field__label">Concurrency limit</span>
            <input class="field__control" type="number" formControlName="concurrencyLimit" min="1" placeholder="1" />
          </label>
          <label class="checkbox checkbox--inline">
            <input type="checkbox" formControlName="autoStopOnError" />
            <span>Auto-stop on critical error</span>
          </label>
        </div>
      </section>

      <section *ngIf="currentStep() === 4" class="launch-dialog__section launch-dialog__section--review" aria-label="Review configuration">
        <dl class="review-grid">
          <div>
            <dt>Bot mode</dt>
            <dd>{{ form.value.nodeType }}</dd>
          </div>
          <div>
            <dt>Strategy</dt>
            <dd>{{ form.value.strategy?.name }} ({{ form.value.strategy?.id }})</dd>
          </div>
          <div>
            <dt>Parameters</dt>
            <dd>
              <ng-container *ngFor="let param of form.value.strategy?.parameters">
                <span class="review-pill">{{ param.key }} = {{ param.value }}</span>
              </ng-container>
            </dd>
          </div>
          <div>
            <dt>Adapters</dt>
            <dd>
              <ng-container *ngFor="let adapter of form.value.adapters">
                <span class="review-pill">
                  {{ adapter.venue }}
                  <ng-container *ngIf="adapter.keyId">• {{ adapter.keyId }}</ng-container>
                  <ng-container *ngIf="adapter.enableData">• data</ng-container>
                  <ng-container *ngIf="adapter.enableTrading">• trading</ng-container>
                </span>
              </ng-container>
              <ng-container *ngIf="!form.value.adapters?.length">
                <span class="review-pill">No adapters selected</span>
              </ng-container>
            </dd>
          </div>
          <div>
            <dt>Constraints</dt>
            <dd>
              <span class="review-pill" *ngIf="form.value.constraints?.maxRuntimeMinutes">
                Max runtime: {{ form.value.constraints?.maxRuntimeMinutes }} min
              </span>
              <span class="review-pill" *ngIf="form.value.constraints?.maxDrawdownPercent">
                Max drawdown: {{ form.value.constraints?.maxDrawdownPercent }}%
              </span>
              <span class="review-pill" *ngIf="form.value.constraints?.concurrencyLimit">
                Concurrency limit: {{ form.value.constraints?.concurrencyLimit }}
              </span>
              <span class="review-pill">
                Auto-stop: {{ form.value.constraints?.autoStopOnError ? 'enabled' : 'disabled' }}
              </span>
            </dd>
          </div>
        </dl>
      </section>

      <p class="launch-dialog__error" *ngIf="stepError()">{{ stepError() }}</p>
      <p class="launch-dialog__error" *ngIf="submissionError()">{{ submissionError() }}</p>

    </form>
    <footer class="launch-dialog__footer">
      <button
        type="button"
        class="btn-tertiary"
        (click)="previousStep()"
        [disabled]="currentStep() === 0"
      >
        Back
      </button>
      <div class="launch-dialog__footer-actions">
        <button
          type="button"
          class="btn-secondary"
          (click)="nextStep()"
          *ngIf="currentStep() < steps.length - 1"
        >
          Next
        </button>
        <button
          type="submit"
          class="btn-primary"
          form="nodeLaunchForm"
          *ngIf="currentStep() === steps.length - 1"
        >
          Launch bot
        </button>
      </div>
    </footer>
  </div> <!-- close launch-dialog__panel -->
</div>
