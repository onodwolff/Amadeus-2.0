<section class="users-page">
  <header class="users-page__header">
    <div class="users-page__header-text">
      <h1 class="users-page__title">User management</h1>
      <p class="users-page__description">
        Review existing operator accounts, adjust role assignments, and invite new teammates with
        appropriate permissions.
      </p>
    </div>
    <button
      mat-flat-button
      color="primary"
      (click)="openCreateDialog()"
      type="button"
      [disabled]="!canManageUsers()"
    >
      Create user
    </button>
  </header>

  <div class="users-page__filters">
    <mat-form-field appearance="outline" class="users-page__filter">
      <mat-label>Filter users</mat-label>
      <input
        matInput
        placeholder="Search by email, name, or role"
        [formControl]="filterControl"
        type="search"
      />
      <button
        mat-button
        matSuffix
        type="button"
        (click)="clearFilter()"
        *ngIf="hasActiveFilters()"
        class="users-page__clear"
      >
        Clear
      </button>
    </mat-form-field>

    <mat-form-field appearance="outline" class="users-page__filter">
      <mat-label>Role</mat-label>
      <mat-select [formControl]="roleFilterControl">
        <mat-option value="all">All roles</mat-option>
        <mat-option *ngFor="let role of roleFilterOptions()" [value]="role.slug">
          {{ role.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="users-page__filter">
      <mat-label>Status</mat-label>
      <mat-select [formControl]="statusFilterControl">
        <mat-option value="all">All statuses</mat-option>
        <mat-option value="active">Active</mat-option>
        <mat-option value="suspended">Suspended</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <p class="users-page__roles-error" *ngIf="rolesError()">{{ rolesError() }}</p>

  <div class="users-page__content" *ngIf="!isLoading(); else loading">
    <table mat-table [dataSource]="dataSource" matSort matSortDisableClear class="users-table">
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Identifier</th>
        <td mat-cell *matCellDef="let user" class="users-table__id">{{ user.id }}</td>
      </ng-container>

      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
        <td mat-cell *matCellDef="let user">{{ user.email }}</td>
      </ng-container>

      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
        <td mat-cell *matCellDef="let user">{{ formatUserName(user) }}</td>
      </ng-container>

      <ng-container matColumnDef="roles">
        <th mat-header-cell *matHeaderCellDef>Roles</th>
        <td mat-cell *matCellDef="let user">
          <div class="users-table__roles">
            <span
              class="users-table__role-chip users-table__role-chip--admin"
              *ngIf="user.roles.includes('admin')"
              matTooltip="Administrator"
            >
              Admin
            </span>
            <ng-container *ngFor="let role of assignableRoles()">
              <mat-slide-toggle
                class="users-table__role-toggle"
                [checked]="user.roles.includes(role.slug)"
                (change)="toggleRole(user, role, $event)"
                [disabled]="isRoleToggleDisabled(user.id, role.slug)"
                [matTooltip]="getRoleTooltip(role)"
                matTooltipShowDelay="200"
              >
                {{ role.name }}
              </mat-slide-toggle>
            </ng-container>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="active">
        <th mat-header-cell *matHeaderCellDef>Active</th>
        <td mat-cell *matCellDef="let user" class="users-table__active">
          <mat-slide-toggle
            [checked]="user.active"
            (change)="toggleUserActive(user, $event)"
            [disabled]="isToggleDisabled(user.id)"
          >
            {{ user.active ? 'Active' : 'Suspended' }}
          </mat-slide-toggle>
        </td>
      </ng-container>

      <ng-container matColumnDef="createdAt">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Created</th>
        <td mat-cell *matCellDef="let user">{{ user.createdAt | date: 'medium' }}</td>
      </ng-container>

      <ng-container matColumnDef="updatedAt">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Updated</th>
        <td mat-cell *matCellDef="let user">{{ user.updatedAt | date: 'medium' }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let user" class="users-table__actions">
          <button
            mat-button
            type="button"
            color="primary"
            (click)="resetTwoFactor(user)"
            [disabled]="isActionDisabled(user.id)"
          >
            Reset 2FA
          </button>
          <button
            mat-button
            type="button"
            color="warn"
            (click)="forceLogout(user)"
            [disabled]="isActionDisabled(user.id)"
          >
            Force logout
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackByUserId"></tr>
    </table>

    <div class="users-page__empty" *ngIf="!dataSource.data.length">
      <h2>No users found</h2>
      <p *ngIf="canViewUsers(); else noPermission">Adjust your filters or invite a new teammate.</p>
      <ng-template #noPermission>
        <p>You do not have sufficient permissions to view the user directory.</p>
      </ng-template>
    </div>
  </div>

  <p class="users-page__error" *ngIf="error()">{{ error() }}</p>

  <ng-template #loading>
    <div class="users-page__loading" role="status" aria-live="polite">
      <mat-spinner diameter="42"></mat-spinner>
      <span>Loading usersâ€¦</span>
    </div>
  </ng-template>
</section>
