# План развития интеграции NautilusTrader

## Текущее состояние
- Gateway использует `MockNautilusService`, который эмулирует портфель, заявки и риск-алерты поверх внутреннего `EngineEventBus`, не подключая реальный движок NautilusTrader.【F:backend/gateway/app/nautilus_service.py†L200-L318】
- В репозитории присутствует полный исходный код NautilusTrader с поддержкой высокопроизводительного event-driven ядра, модульных адаптеров и продвинутых торговых возможностей, которые стоит задействовать вместо заглушек.【F:vendor/nautilus_trader/README.md†L42-L155】

## Этап 1. Поднятие базового узла NautilusTrader через gateway
1. **Загрузка конфигураций узлов**  
   Реализовать в `NautilusEngineService` методы для загрузки YAML/JSON конфигураций NautilusTrader (стратегии, адаптеры, стораж) и хранения их в каталоге `.gateway`. Добавить проверку схемы и выдачу подробных ошибок в API `/nodes/launch`.
2. **Запуск backtest/live узлов**  
   Используя конфигурацию, запускать соответствующие `TradingNode` экземпляры NautilusTrader для backtest и live режимов, перенаправляя стандартный вывод и события состояния в существующий `EngineEventBus` для публикации в WebSocket.
3. **Синхронизация телеметрии**  
   Пробросить из реального движка метрики (PnL, задержки, использование CPU/RAM), статусы узлов и жизненный цикл, чтобы заменить генерацию синтетических данных в `MockNautilusService`.

## Этап 2. Реальные рыночные данные и торговые операции
1. **Интеграция адаптеров**  
   Добавить в UI и API возможность выбора поддерживаемых адаптеров NautilusTrader (например, Binance, Bybit, Interactive Brokers) и хранение привязок ключей. При запуске узла автоматически активировать выбранные адаптеры и проверять статус подключения.【F:vendor/nautilus_trader/README.md†L42-L143】
2. **Исторические данные**  
   Реализовать загрузку исторических котировок через встроенные data-provider адаптеры (Databento, Tardis) и кеширование датасетов для повторного использования в backtest сценариях.
3. **Продвинутые типы ордеров**  
   Расширить эндпоинт `/orders` для поддержки всех доступных инструкций NautilusTrader (IOC/FOK/GTC/GTD, post-only/reduce-only, OCO/OTO/OUO), обеспечив валидацию и отображение в UI.【F:vendor/nautilus_trader/README.md†L48-L59】

## Этап 3. Риск-менеджмент и многоузловая координация
1. **Реальные риск-алерты**  
   Подключить риск-модули NautilusTrader к event bus и заменить генерацию фиктивных алертов. Добавить управление порогами и эскалацией в API.
2. **Кластер узлов**  
   Реализовать координацию нескольких торговых узлов (multi-venue / multi-strategy) с общим мониторингом и управлением ордерами в gateway, используя многовенговые возможности NautilusTrader.【F:vendor/nautilus_trader/README.md†L42-L59】
3. **Персистентность состояний**  
   Настроить использование Redis или другого поддерживаемого state backend для сохранения позиций, ордеров и логов между перезапусками узлов, синхронизируя их с внутренним хранилищем gateway.

## Этап 4. Автоматизация и AI-интеграция
1. **Авто-тестирование стратегий**  
   Настроить пайплайн пакетного запуска backtest сценариев (параметрические сетки, Monte Carlo) поверх движка NautilusTrader, включая агрегирование результатов и публикацию метрик.
2. **Интеграция с AI-агентами**  
   Предоставить API/SDK для внешних ML/AI агентов, использующих backtest движок NautilusTrader для обучения и последующей публикации стратегий в live торговлю.【F:vendor/nautilus_trader/README.md†L56-L59】
3. **Непрерывный контроль качества**  
   Добавить автоматические проверки конфигураций и сценариев (linting, smoke-tests) перед деплоем стратегий, чтобы соответствовать требованиям к надёжности и безопасности производственных узлов NautilusTrader.【F:vendor/nautilus_trader/README.md†L50-L73】

## Следующие шаги
- Согласовать приоритеты этапов с продуктовой командой и определить SLA для запуска первых реальных стратегий.
- Подготовить технические спецификации на реализуемые API/модули, согласовав формат обмена с фронтендом и операционными командами.
- Начать с внедрения Этапа 1, чтобы как можно быстрее получить реальный поток данных из NautilusTrader и протестировать end-to-end сценарий.
